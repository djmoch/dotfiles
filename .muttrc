# {{{ Headers
ignore *
unignore from: subject to cc date x-mailer x-url user-agent list-id

hdr_order date from to cc subject list-id
# }}}

# {{{ Macros
macro index \eb "<search>~b " "search in message bodies"

macro index,pager,attach,compose \cb "\
<enter-command> set my_pipe_decode=\$pipe_decode pipe_decode<Enter>\
<pipe-message> urlview<Enter>\
<enter-command> set pipe_decode=\$my_pipe_decode; unset my_pipe_decode<Enter>" \
"call urlview to extract URLs out of a message"

macro generic,pager <F1> "<shell-escape> less /usr/share/doc/mutt/manual.txt<Enter>" "show Mutt documentation"

macro index,pager y "<change-folder>?<toggle-mailboxes>" "show incoming mailboxes list"

macro index <F9> "<sync-mailbox><enter-command>source ~/.config/mutt/account.dotcom<enter><change-folder>!<enter>"
macro index <F10> "<sync-mailbox><enter-command>source ~/.config/mutt/account.icloud<enter><change-folder>!<enter>"
macro index <F8> \
"<enter-command>set my_old_pipe_decode=\$pipe_decode my_old_wait_key=\$wait_key nopipe_decode nowait_key<enter>\
<shell-escape>notmuch-mutt -r --prompt search<enter>\
<change-folder-readonly>`echo ${XDG_CACHE_HOME:-$HOME/.cache}/notmuch/mutt/results`<enter>\
<enter-command>set pipe_decode=\$my_old_pipe_decode wait_key=\$my_old_wait_key<enter>" \
"notmuch: search mail"

macro index <F4> \
"<enter-command>set my_old_pipe_decode=\$pipe_decode my_old_wait_key=\$wait_key nopipe_decode nowait_key<enter>\
<pipe-message>notmuch-mutt -r thread<enter>\
<change-folder-readonly>`echo ${XDG_CACHE_HOME:-$HOME/.cache}/notmuch/mutt/results`<enter>\
<enter-command>set pipe_decode=\$my_old_pipe_decode wait_key=\$my_old_wait_key<enter>" \
"notmuch: reconstruct thread"

macro generic,pager <F5> "<enter-command>toggle sidebar_visible<enter>" "Toggle the sidebar"
# }}}

# {{{ Hooks
message-hook '~s .*' 'uncolor body red default "^-.*"'
message-hook '~s .*' 'uncolor body green default "^\\+.*"'
message-hook '~s .*' 'uncolor body cyan default "^@@.*"'
message-hook '~s .*' 'uncolor body brightwhite default "^(diff|index|new|\\+\\+\\+|---).*"'
message-hook '~s \\[PATCH' 'color body red default "^-.*"'
message-hook '~s \\[PATCH' 'color body green default "^\\+.*"'
message-hook '~s \\[PATCH' 'color body cyan default "^@@.*"'
message-hook '~s \\[PATCH' 'color body brightwhite default "^(diff\\s|index\\s|new\\s|\\+\\+\\+|---).*"'
# }}}

# {{{ General Settings
set realname			= "Daniel Moch"
set sendmail_wait		= -1
set sort			= "reverse-threads"
set strict_threads		= "yes"
set sort_browser		= "alpha"
set sort_aux			= "last-date-received"
set query_command		= "khard email --parsable --search-in-source-files '%s'"
set sidebar_sort_method		= "alpha"
set sidebar_visible
unset collapse_unread

bind browser y exit
bind index - collapse-thread
bind index _ collapse-all
bind index J sidebar-next
bind index K sidebar-prev
bind index O sidebar-open
bind pager j next-line
bind pager <Down> next-line
bind pager k previous-line
bind pager <Up> previous-line
bind pager \Cu half-up
bind pager \Cd half-down

mime_lookup application/octet-stream

attachments   +A */.*
attachments   -A text/x-vcard application/pgp.*
attachments   -A application/x-pkcs7-.*
attachments   +I text/plain
attachments   -A message/external-body
attachments   -I message/external-body

auto_view text/html
alternative_order text/plain text/enriched text/html
# }}}

# {{{ GPG
set pgp_decode_command="gpg --status-fd=2 %?p?--passphrase-fd 0? --no-verbose --quiet --batch --output - %f"
set pgp_verify_command="gpg --status-fd=2 --no-verbose --quiet --batch --output - --verify %s %f"
set pgp_decrypt_command="gpg --status-fd=2 %?p?--passphrase-fd 0? --no-verbose --quiet --batch --output - %f"
set pgp_sign_command="gpg --no-verbose --batch --quiet --output - %?p?--passphrase-fd 0? --armor --detach-sign --textmode %?a?-u %a? %f"
set pgp_clearsign_command="gpg --no-verbose --batch --quiet --output - %?p?--passphrase-fd 0? --armor --textmode --clearsign %?a?-u %a? %f"
set pgp_encrypt_only_command="pgpewrap gpg --batch --quiet --no-verbose --output - --encrypt --textmode --armor --always-trust -- -r %r -- %f"
set pgp_encrypt_sign_command="pgpewrap gpg %?p?--passphrase-fd 0? --batch --quiet --no-verbose --textmode --output - --encrypt --sign %?a?-u %a? --armor --always-trust -- -r %r -- %f"
set pgp_import_command="gpg --no-verbose --import %f"
set pgp_export_command="gpg --no-verbose --export --armor %r"
set pgp_verify_key_command="gpg --verbose --batch --fingerprint --check-sigs %r"
set pgp_list_pubring_command="gpg --no-verbose --batch --quiet --with-colons --with-fingerprint --with-fingerprint --list-keys %r"
set pgp_list_secring_command="gpg --no-verbose --batch --quiet --with-colons --with-fingerprint --with-fingerprint --list-secret-keys %r"
set pgp_good_sign="^\\[GNUPG:\\] GOODSIG"
set pgp_decryption_okay="^\\[GNUPG:\\] DECRYPTION_OKAY"
# }}}

# {{{ S/MIME
set smime_timeout=300
set crypt_autosign = yes
set crypt_replyencrypt = yes
set crypt_replysign = yes
set crypt_replysignencrypted = yes
set crypt_verify_sig = yes
set smime_default_key="12345678.0"
set smime_ca_location="/usr/local/etc/openssl/cert.pem"
set smime_certificates="~/.mutt/smime/certificates"
set smime_keys="~/.mutt/smime/keys"
set smime_pk7out_command="openssl smime -verify -in %f -noverify -pk7out"
set smime_get_cert_command="openssl pkcs7 -print_certs -in %f"
set smime_get_signer_cert_command="openssl smime -verify -in %f -noverify -signer %c -out /dev/null"
set smime_get_cert_email_command="openssl x509 -in %f -noout -email"
set smime_import_cert_command="smime_keys add_cert %f"
set smime_encrypt_with="aes256"
set smime_encrypt_command="openssl smime -encrypt -%a -outform DER -in %f %c"
set smime_sign_digest_alg="sha256"
set smime_sign_command="openssl smime -sign -md %d -signer %c -inkey %k -passin stdin -in %f -certfile %i -outform DER"
set smime_decrypt_command="openssl smime -decrypt -passin stdin -inform DER -in %f -inkey %k -recip %c"
set smime_verify_command="openssl smime -verify -inform DER -in %s %C -content %f"
set smime_verify_opaque_command="\
openssl smime -verify -inform DER -in %s %C || \
openssl smime -verify -inform DER -in %s -noverify 2>/dev/null"
# }}}

# {{{ Colors
color	normal				default		default
color	error				brightred	default
color	tilde				default		default
color	message				default		default
color	markers				default		default
color	attachment			default		default
color	search				default		default
color	status				brightwhite	blue
color	indicator			default		white
color	tree				blue		default

mono	bold		bold
mono	underline	underline
mono	indicator	reverse
mono	error		bold

color	index				default		default		"~A"			# all messages
color	index				red		default		"~E"			# expired messages
color	index				default		default		"~N"			# new messages
color	index				default		default		"~O"			# old messages
color	index				default		default		"~Q"			# messages that have been replied to
color	index				default		default		"~R"			# read messages
color	index				default		default		"~U"			# unread messages
color	index				default		default		"~U~$"			# unread, unreferenced messages
color	index				default		default		"~v"			# messages part of a collapsed thread
color	index				white		default		"~P"			# messages from me
color	index				blue		default		"~p!~F"			# messages to me
color	index				blue		default		"~N~p!~F"		# new messages to me
color	index				blue		default		"~U~p!~F"		# unread messages to me
color	index				blue		default		"~R~p!~F"		# messages to me
color	index				brightgreen	default		"~F"			# flagged messages
color	index				brightgreen	default		"~F~p"			# flagged messages to me
color	index				brightgreen	default		"~N~F"			# new flagged messages
color	index				brightgreen	default		"~N~F~p"		# new flagged messages to me
color	index				brightgreen	default		"~U~F~p"		# new flagged messages to me
color	index				brightwhite	red		"~D"			# deleted messages
color	index				white		default		"~v~(!~N)"		# collapsed thread with no unread
color	index				default		default		"~v~(~N)"		# collapsed thread with some unread
color	index				white		default		"~N~v~(~N)"		# collapsed thread with unread parent
color	index				brightgreen	default		"~v~(~F)!~N"		# collapsed thread with flagged, no unread
color	index				default		default		"~v~(~F~N)"		# collapsed thread with some unread & flagged
color	index				brightgreen	default		"~N~v~(~F~N)"		# collapsed thread with unread parent & flagged
color	index				brightgreen	default		"~N~v~(~F)"		# collapsed thread with unread parent, no unread inside, but some flagged
color	index				white		default		"~v~(~p)"		# collapsed thread with unread parent, no unread inside, some to me directly
color	index				black		red		"~v~(~D)"		# thread with deleted (doesn't differentiate between all or partial)
color	hdrdefault			default		default
color	header				default		default		"^(From)"
color	header				default		default		"^(Subject)"
color	quoted				green		default
color	quoted1				magenta		default
color	quoted2				green		default
color	quoted3				red		default
color	quoted4				yellow		default
color	signature			default		default
color	bold				default		default
color	underline	underline	default		default
color	normal				default		default
color	body		bold		default		default		"[;:][-o][)/(|]"	# emoticons
color	body		bold		default		default		"[;:][)(|]"		# emoticons
color	body		bold		default		default		"[*]?((N)?ACK|CU|LOL|SCNR|BRB|BTW|CWYL|\
										|FWIW|vbg|GD&R|HTH|HTHBE|IMHO|IMNSHO|\
										|IRL|RTFM|ROTFL|ROFL|YMMV)[*]?"
color	body		bold		default		default		"[ ][*][^*]*[*][ ]?"	# more emoticon?
color	body		bold		default		default		"[ ]?[*][^*]*[*][ ]"	# more emoticon?
color	body				brightwhite	red		"(BAD signature)"
color	body				default		default		"(Good signature)"
color	body				default		default		"^gpg:Good signature .*"
color	body				default		default		"^gpg: "
color	body				brightwhite	red		"^gpg:BAD signature from.*"
mono	body		bold						"^gpg: Good signature"
mono	body		bold						"^gpg: BAD signature from.*"
color	body				blue		default		"([a-z][a-z0-9+-]*://(((([a-z0-9_.!~*'();:&=+$,-]|%[0-9a-f][0-9a-f])*@)?((([a-z0-9]([a-z0-9-]*[a-z0-9])?)\\.)*([a-z]([a-z0-9-]*[a-z0-9])?)\\.?|[0-9]+\\.[0-9]+\\.[0-9]+\\.[0-9]+)(:[0-9]+)?)|([a-z0-9_.!~*'()$,;:@&=+-]|%[0-9a-f][0-9a-f])+)(/([a-z0-9_.!~*'():@&=+$,-]|%[0-9a-f][0-9a-f])*(;([a-z0-9_.!~*'():@&=+$,-]|%[0-9a-f][0-9a-f])*)*(/([a-z0-9_.!~*'():@&=+$,-]|%[0-9a-f][0-9a-f])*(;([a-z0-9_.!~*'():@&=+$,-]|%[0-9a-f][0-9a-f])*)*)*)?(\\?([a-z0-9_.!~*'();/?:@&=+$,-]|%[0-9a-f][0-9a-f])*)?(#([a-z0-9_.!~*'();/?:@&=+$,-]|%[0-9a-f][0-9a-f])*)?|(www|ftp)\\.(([a-z0-9]([a-z0-9-]*[a-z0-9])?)\\.)*([a-z]([a-z0-9-]*[a-z0-9])?)\\.?(:[0-9]+)?(/([-a-z0-9_.!~*'():@&=+$,]|%[0-9a-f][0-9a-f])*(;([-a-z0-9_.!~*'():@&=+$,]|%[0-9a-f][0-9a-f])*)*(/([-a-z0-9_.!~*'():@&=+$,]|%[0-9a-f][0-9a-f])*(;([-a-z0-9_.!~*'():@&=+$,]|%[0-9a-f][0-9a-f])*)*)*)?(\\?([-a-z0-9_.!~*'();/?:@&=+$,]|%[0-9a-f][0-9a-f])*)?(#([-a-z0-9_.!~*'();/?:@&=+$,]|%[0-9a-f][0-9a-f])*)?)[^].,:;!)?	\t\r\n<>\"]"
color	body				blue		default		"((@(([0-9a-z-]+\\.)*[0-9a-z-]+\\.?|#[0-9]+|\\[[0-9]?[0-9]?[0-9]\\.[0-9]?[0-9]?[0-9]\\.[0-9]?[0-9]?[0-9]\\.[0-9]?[0-9]?[0-9]\\]),)*@(([0-9a-z-]+\\.)*[0-9a-z-]+\\.?|#[0-9]+|\\[[0-9]?[0-9]?[0-9]\\.[0-9]?[0-9]?[0-9]\\.[0-9]?[0-9]?[0-9]\\.[0-9]?[0-9]?[0-9]\\]):)?[0-9a-z_.+%$-]+@(([0-9a-z-]+\\.)*[0-9a-z-]+\\.?|#[0-9]+|\\[[0-2]?[0-9]?[0-9]\\.[0-2]?[0-9]?[0-9]\\.[0-2]?[0-9]?[0-9]\\.[0-2]?[0-9]?[0-9]\\])"
# }}}

source ~/.config/mutt/account.default
