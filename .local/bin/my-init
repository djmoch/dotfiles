#!/bin/sh
#
# ~/.local/bin/my-init
#
# A place to dump run-once type initializations

vim_bundle_path="$HOME/.vim/pack/bundle"

__has()
{
    for token in $@
    do
        type $token > /dev/null 2>&1
        [ $? -ne 0 ] && echo "$token doesn't exist" && return 1
    done
    return 0
}

__clone()
{
    echo -n "  Cloning $1 ... "
    git clone https://github.com/$1.git > /dev/null 2>&1
    [ $? -ne 0 ] && echo "FAILED!" && return 1
    echo "Succeeded"
}

__optclone_pathogen()
{
    vim --cmd "redir! > /tmp/djmoch-vimpackages | silent echo has('packages') | q"
    case `cat /tmp/djmoch-vimpackages` in
        *0*)
            echo -n "  Cloning tpope/vim-pathogen ... "
            git clone https://github.com/tpope/vim-pathogen.git > /dev/null 2>&1
            [ $? -ne 0 ] && echo "FAILED!" && return 1
            echo "Succeeded"
            ;;
    esac
}

echo "Performing run-once initializations"

if [ -n "$1" -a "$1" = "-f" ]
then
    echo " Re-initialization requested"
    rm -f "$HOME/._.djmoch"
    rm -rf "$HOME/.terminfo"
    rm -rf "$vim_bundle_path"
    rm "$HOME/.less"
    type crontab > /dev/null 2>&1 && crontab -r
fi

# Terminfo
if __has "infocmp" "tic" && [ ! -d "$HOME/.terminfo" ]
then
    echo " Initializing Termcaps"
    if infocmp tmux-256color > /dev/null 2>&1
    then
        tic "$HOME/.config/terminfo/tmux.terminfo"
    else
        tic "$HOME/.config/terminfo/tmux-from-screen.terminfo"
    fi
fi

# Lesskey
if __has "lesskey" && [ ! -f "$HOME/.less" ]
then
    echo " Initializing .less"
    lesskey
fi

if __has "crontab"
then
    echo " Installing crontab"
    cat "$HOME/.config/cron/crontab" | crontab -
fi

# Vim plugins
if __has "vim" "git" && [ ! -d "$vim_bundle_path" ]
then
    echo " Downloading Vim plugins"
    # Plugins that should always be enabled
    mkdir -p $vim_bundle_path/start
    cd $vim_bundle_path/start
    __clone romainl/Apprentice
    __clone tpope/vim-commentary
    __clone tpope/vim-eunuch
    __clone tpope/vim-fugitive
    __clone tpope/vim-obsession
    __clone tpope/vim-scriptease
    __clone tpope/vim-surround
    __clone tpope/vim-unimpaired
    __clone tpope/vim-vinegar
    __clone Raimondi/delimitMate
    __clone junegunn/goyo.vim
    __clone junegunn/limelight.vim
    __clone ajh17/VimCompletesMe
    __clone skammer/vim-css-color
    __clone ludovicchabant/vim-gutentags
    __clone beloglazov/vim-online-thesaurus
    __clone jszakmeister/vim-togglecursor
    __clone chr4/sslsecure.vim
    __optclone_pathogen
    cd - > /dev/null 2>&1

    # Plugins used optionally
    mkdir -p $vim_bundle_path/opt
    cd $vim_bundle_path/opt
    __clone jpalardy/vim-slime
    cd - > /dev/null 2>&1
fi

if [ ! -f "$HOME/._.djmoch" ]
then
    touch "$HOME/._.djmoch"
    chmod 000 "$HOME/._.djmoch"
fi

unset __clone __has __optclone_pathogen
